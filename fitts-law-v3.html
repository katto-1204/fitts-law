<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Fitt's Law â€” Performance Trial</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link
    href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800;900&family=Space+Mono:wght@400;700&display=swap"
    rel="stylesheet">
  <style>
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• RESET & BASE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    *,
    *::before,
    *::after {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --bg: #121212;
      --surf: rgba(255, 255, 255, 0.05);
      --glass: rgba(255, 255, 255, 0.08);
      --glass-border: rgba(255, 255, 255, 0.12);
      --border: rgba(255, 255, 255, 0.1);
      --acc: #FC4C02;
      /* Strava Orange */
      --acc-gradient: linear-gradient(135deg, #FC4C02 0%, #E34202 100%);
      --text: #ffffff;
      --muted: #888888;
      --muted2: #aaaaaa;
      --fdisplay: 'Outfit', sans-serif;
      --fmono: 'Space Mono', monospace;
      --fbody: 'Outfit', sans-serif;
    }

    html,
    body {
      min-height: 100vh;
      background: #000;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-family: var(--fbody);
      margin: 0;
      overflow: hidden;
      color: var(--text);
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• PHONE SHELL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .phone-wrap {
      position: relative;
    }

    .phone-bezel {
      width: 393px;
      height: 852px;
      background: #000;
      border-radius: 54px;
      padding: 12px;
      box-shadow:
        0 0 0 1px rgba(255, 255, 255, 0.1),
        0 30px 60px rgba(0, 0, 0, 0.5);
      position: relative;
    }

    .phone-screen {
      width: 100%;
      height: 100%;
      background: var(--bg);
      border-radius: 42px;
      overflow: hidden;
      position: relative;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• STATUS BAR â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .status-bar {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 54px;
      display: flex;
      align-items: flex-end;
      justify-content: space-between;
      padding: 0 32px 8px;
      z-index: 100;
      pointer-events: none;
    }

    .status-time {
      font-size: 15px;
      font-weight: 700;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• NAVIGATION â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .screen {
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
      transition: opacity 0.4s ease, transform 0.4s ease;
      overflow: hidden;
      padding-top: 54px;
      padding-bottom: 30px;
    }

    .screen.hidden {
      opacity: 0;
      pointer-events: none;
      transform: scale(0.96);
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• SHARED UI â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .tag {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: rgba(252, 76, 2, 0.1);
      border: 1px solid rgba(252, 76, 2, 0.2);
      color: var(--acc);
      font-size: 10px;
      font-weight: 800;
      padding: 6px 14px;
      border-radius: 50px;
      text-transform: uppercase;
      letter-spacing: 0.1em;
    }

    .cta-btn {
      width: 100%;
      height: 52px;
      background: var(--acc-gradient);
      color: #fff;
      border: none;
      border-radius: 6px;
      /* Strava uses slightly sharper corners on some buttons, but let's go rounded-ish */
      border-radius: 26px;
      font-family: var(--fbody);
      font-size: 15px;
      font-weight: 900;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: transform 0.1s, opacity 0.2s;
      text-transform: uppercase;
    }

    .cta-btn:active {
      transform: scale(0.98);
      opacity: 0.9;
    }

    .divider {
      height: 1px;
      background: var(--border);
      margin: 16px 26px;
      flex-shrink: 0;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• v3.1 ATHLETIC UI â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .bpm-box {
      display: flex;
      align-items: center;
      gap: 6px;
      background: rgba(0, 0, 0, 0.4);
      padding: 4px 10px;
      border-radius: 20px;
      border: 1px solid rgba(255, 0, 0, 0.2);
    }

    .bpm-icon {
      color: #ff3b30;
      font-size: 14px;
      animation: heart-beat 0.8s infinite;
    }

    @keyframes heart-beat {
      0% {
        transform: scale(1);
      }

      15% {
        transform: scale(1.25);
      }

      30% {
        transform: scale(1);
      }

      45% {
        transform: scale(1.15);
      }

      60% {
        transform: scale(1);
      }
    }

    .bpm-val {
      font-size: 14px;
      font-weight: 900;
      font-variant-numeric: tabular-nums;
    }

    .progress-wrap {
      width: 100%;
      height: 4px;
      background: rgba(255, 255, 255, 0.1);
      position: absolute;
      top: 0;
      left: 0;
      overflow: hidden;
    }

    .progress-bar {
      width: 0%;
      height: 100%;
      background: var(--acc);
      transition: width 0.3s ease;
    }

    .splits-grid {
      display: flex;
      flex-direction: column;
      gap: 1px;
      background: var(--border);
      border-radius: 12px;
      overflow: hidden;
      margin: 12px 26px 24px;
      border: 1px solid var(--border);
    }

    .split-row {
      background: var(--bg);
      display: flex;
      justify-content: space-between;
      padding: 12px 16px;
      align-items: center;
    }

    .split-name {
      font-size: 12px;
      font-weight: 700;
      text-transform: uppercase;
      color: var(--muted2);
    }

    .split-val {
      font-size: 14px;
      font-weight: 900;
      color: var(--text);
    }

    .pb-badge {
      display: none;
      background: #ffcc00;
      color: #000;
      font-size: 10px;
      font-weight: 900;
      padding: 4px 12px;
      border-radius: 4px;
      text-transform: uppercase;
      margin-bottom: 12px;
      align-self: flex-start;
      margin-left: 26px;
    }

    .pb-badge.active {
      display: inline-flex;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• SCREEN 1 â€” SPLASH â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    #s1 {
      padding: 54px 26px 30px;
    }

    .s1-hero {
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    .s1-title {
      font-size: 80px;
      font-weight: 900;
      line-height: 0.9;
      letter-spacing: -3px;
      text-transform: uppercase;
      margin: 20px 0;
    }

    .s1-title em {
      display: block;
      color: var(--acc);
      font-style: normal;
    }

    .glass-badge {
      width: 100px;
      height: 100px;
      background: var(--glass);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-radius: 24px;
      border: 1px solid var(--glass-border);
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 32px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
    }

    .glass-badge::after {
      content: 'â–²';
      color: var(--acc);
      font-size: 42px;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• SCREEN 2 â€” INSTRUCTIONS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    #s2 {
      padding: 54px 26px 30px;
    }

    .s2-title {
      font-size: 42px;
      font-weight: 900;
      line-height: 1;
      text-transform: uppercase;
      margin-bottom: 24px;
      letter-spacing: -1px;
    }

    .card-list {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 12px;
      overflow-y: auto;
    }

    .glass-card {
      background: var(--glass);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid var(--glass-border);
      border-radius: 16px;
      padding: 16px;
      display: flex;
      gap: 16px;
    }

    .card-icon {
      font-size: 20px;
      width: 40px;
      height: 40px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .card-info h3 {
      font-size: 14px;
      font-weight: 800;
      margin-bottom: 4px;
    }

    .card-info p {
      font-size: 12px;
      color: var(--muted2);
      line-height: 1.4;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• SCREEN 3 â€” ARENA â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    #s3 {
      background: #000;
    }

    .arena-header {
      padding: 64px 26px 20px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: flex-end;
    }

    .arena-label {
      font-size: 11px;
      font-weight: 900;
      color: var(--acc);
      text-transform: uppercase;
      letter-spacing: 0.1em;
    }

    .stats-row {
      display: flex;
      gap: 24px;
    }

    .stat-pill {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
    }

    .stat-val {
      font-size: 32px;
      font-weight: 900;
      line-height: 1;
    }

    .stat-lbl {
      font-size: 9px;
      font-weight: 700;
      color: var(--muted);
      text-transform: uppercase;
      margin-top: 2px;
    }

    .arena {
      flex: 1;
      position: relative;
      overflow: hidden;
    }

    .tgt {
      position: absolute;
      border-radius: 50%;
      background: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 900;
      font-size: 12px;
      color: #000;
      cursor: pointer;
      opacity: 0;
      pointer-events: none;
      transition: transform 0.1s, opacity 0.2s;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
    }

    .tgt.pulse {
      animation: tgtPulse 0.5s infinite alternate ease-in-out;
    }

    @keyframes tgtPulse {
      from {
        transform: scale(1);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
      }

      to {
        transform: scale(1.05);
        box-shadow: 0 0 20px rgba(252, 76, 2, 0.4);
      }
    }

    .tgt.active-t {
      opacity: 1;
      pointer-events: auto;
      background: var(--acc);
      color: #fff;
    }

    .toast {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 14px;
      font-weight: 900;
      color: rgba(255, 255, 255, 0.2);
      text-transform: uppercase;
      letter-spacing: 0.2em;
      pointer-events: none;
    }

    .anchor-zone {
      padding: 32px 26px;
      background: var(--bg);
      border-top: 1px solid var(--border);
      display: flex;
      justify-content: center;
    }

    .anchor-btn {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: var(--acc);
      color: #fff;
      border: none;
      font-weight: 900;
      font-size: 13px;
      cursor: pointer;
      box-shadow: 0 10px 20px rgba(252, 76, 2, 0.3);
    }

    .anchor-btn.waiting {
      background: #333;
      animation: pulse 1s infinite alternate;
    }

    @keyframes pulse {
      from {
        transform: scale(1);
        opacity: 1;
      }

      to {
        transform: scale(1.05);
        opacity: 0.8;
      }
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• SCREEN 4 â€” RESULTS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    #s4 {
      padding: 54px 0 0;
      background: #000;
      overflow-y: auto;
    }

    .results-head {
      padding: 0 26px 24px;
    }

    .res-eyebrow {
      font-size: 11px;
      font-weight: 900;
      color: var(--muted2);
      text-transform: uppercase;
      margin-bottom: 8px;
    }

    .res-title {
      font-size: 52px;
      font-weight: 900;
      line-height: 0.95;
      text-transform: uppercase;
      letter-spacing: -2px;
    }

    .map-placeholder {
      width: 100%;
      height: 200px;
      background: #111;
      background-image:
        radial-gradient(circle at 2px 2px, rgba(255, 255, 255, 0.05) 1px, transparent 0);
      background-size: 20px 20px;
      position: relative;
      overflow: hidden;
      margin-bottom: 24px;
      border-bottom: 1px solid var(--border);
    }

    .map-placeholder::after {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(to top, #000 0%, transparent 40%, transparent 100%);
    }

    .gps-path {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
    }

    .gps-line {
      fill: none;
      stroke: var(--acc);
      stroke-width: 3;
      stroke-linecap: round;
      stroke-linejoin: round;
      filter: drop-shadow(0 0 8px rgba(252, 76, 2, 0.6));
    }

    .gps-marker {
      fill: #fff;
      stroke: var(--acc);
      stroke-width: 2;
    }

    .gps-marker.end {
      fill: var(--acc);
    }

    .results-stats {
      padding: 0 26px 40px;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    .res-card {
      background: var(--glass);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      padding: 20px;
      border-radius: 16px;
      border: 1px solid var(--glass-border);
    }

    .res-card.wide {
      grid-column: 1 / -1;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• v3.2 MAP & ARENA â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .arena-bg-map {
      position: absolute;
      inset: 0;
      opacity: 0.15;
      pointer-events: none;
      z-index: 0;
    }

    .arena-grid {
      position: absolute;
      inset: 0;
      background-image:
        radial-gradient(circle at 1.5px 1.5px, rgba(255, 255, 255, 0.05) 1px, transparent 0);
      background-size: 24px 24px;
      pointer-events: none;
    }

    .tgt {
      position: absolute;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 900;
      font-size: 0;
      /* Hide label, use dot */
      color: #fff;
      cursor: pointer;
      opacity: 0;
      pointer-events: none;
      transition: transform 0.2s, opacity 0.2s, background 0.2s;
      z-index: 2;
    }

    .tgt::after {
      content: '';
      width: 6px;
      height: 6px;
      background: rgba(255, 255, 255, 0.3);
      border-radius: 50%;
    }

    .tgt.active-t {
      opacity: 1;
      pointer-events: auto;
      background: rgba(252, 76, 2, 0.15);
      border: 3px solid var(--acc);
      box-shadow: 0 0 20px rgba(252, 76, 2, 0.4);
      transform: scale(1.1);
    }

    .tgt.active-t::after {
      background: #fff;
      width: 8px;
      height: 8px;
      box-shadow: 0 0 10px #fff;
    }

    #live-pace-box {
      border-left: 1px solid var(--border);
      padding-left: 20px;
    }

    .gps-lock-overlay {
      position: absolute;
      inset: 0;
      background: #000;
      z-index: 2000;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 16px;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s;
    }

    .gps-lock-overlay.active {
      opacity: 1;
      pointer-events: auto;
    }

    .gps-spinner {
      width: 40px;
      height: 40px;
      border: 3px solid rgba(252, 76, 2, 0.2);
      border-top-color: var(--acc);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .res-val {
      font-size: 42px;
      font-weight: 900;
      color: var(--acc);
      line-height: 1;
      margin-bottom: 4px;
    }

    .res-lbl {
      font-size: 10px;
      font-weight: 700;
      color: var(--muted2);
      text-transform: uppercase;
    }

    .home-link {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 9999;
      background: var(--acc);
      color: #fff;
      padding: 8px 16px;
      border-radius: 4px;
      font-weight: 900;
      text-decoration: none;
      font-size: 12px;
      text-transform: uppercase;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• FEEDBACK â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .ripple {
      position: absolute;
      border-radius: 50%;
      pointer-events: none;
      animation: ripple-expand 0.5s ease-out forwards;
      background: rgba(255, 255, 255, 0.4);
    }

    @keyframes ripple-expand {
      to {
        transform: scale(4);
        opacity: 0;
      }
    }

    .time-badge {
      position: absolute;
      background: var(--acc);
      color: #fff;
      font-size: 11px;
      font-weight: 900;
      padding: 4px 10px;
      border-radius: 20px;
      pointer-events: none;
      animation: badge-rise 0.8s ease-out forwards;
    }

    @keyframes badge-rise {
      from {
        transform: translateY(0);
        opacity: 1;
      }

      to {
        transform: translateY(-40px);
        opacity: 0;
      }
    }
  </style>
</head>

<body>

  <a href="index.html" class="home-link">Home</a>

  <div class="phone-wrap">
    <div class="phone-bezel">
      <div class="phone-screen">

        <div class="status-bar">
          <div class="status-time">9:41</div>
          <div class="bpm-box" id="bpm-display" style="display: none;">
            <span class="bpm-icon">â¤</span>
            <span class="bpm-val" id="bpm-val">122</span>
          </div>
          <div class="tag" style="padding: 2px 8px; font-size: 8px;">GPS ACTIVE</div>
        </div>

        <!-- SCREEN 1 -->
        <div class="screen" id="s1">
          <div class="s1-hero">
            <div class="glass-badge"></div>
            <div class="tag">PERFORMANCE LAB</div>
            <h1 class="s1-title">FITT'S<br><em>TRIAL</em></h1>
            <p style="font-size: 14px; color: var(--muted2); line-height: 1.5; font-weight: 500;">
              Analyze your movement efficiency through high-intensity target acquisition.
            </p>
          </div>
          <button class="cta-btn" onclick="goTo('s2')">View Instructions</button>
        </div>

        <!-- SCREEN 2 -->
        <div class="screen hidden" id="s2">
          <h2 class="s2-title">Training<br>Setup</h2>
          <div class="card-list">
            <div class="glass-card">
              <div class="card-icon">ğŸ¯</div>
              <div class="card-info">
                <h3>Objective</h3>
                <p>Tap the orange target, then quickly return to START.</p>
              </div>
            </div>
            <div class="glass-card">
              <div class="card-icon">ğŸ“</div>
              <div class="card-info">
                <h3>Variable Size</h3>
                <p>Targets scale from 22px to 50px to test precision limits.</p>
              </div>
            </div>
            <div class="glass-card">
              <div class="card-icon">âš¡</div>
              <div class="card-info">
                <h3>Fast Effort</h3>
                <p>Speed matters. Every millisecond counts toward your performance score.</p>
              </div>
            </div>
          </div>
          <button class="cta-btn" onclick="startExperiment()" style="margin-top: 24px;">Start Workout</button>
        </div>

        <!-- SCREEN 3 -->
        <div class="screen hidden" id="s3">
          <div class="progress-wrap">
            <div class="progress-bar" id="p-bar"></div>
          </div>
          <div class="arena-header">
            <div class="arena-label">Active Session</div>
            <div class="stats-row">
              <div class="stat-pill" id="live-pace-box">
                <span class="stat-val" id="live-pace">â€”</span>
                <span class="stat-lbl">Pace</span>
              </div>
              <div class="stat-pill" id="v3-ghost-pill" style="display: none;">
                <div class="stat-val" id="v3-ghost-delta" style="color: #FC4C02;">+0.0s</div>
                <div class="stat-lbl">GHOST</div>
              </div>
              <div class="stat-pill">
                <div class="stat-val" id="hit-count">0</div>
                <div class="stat-lbl">HITS</div>
              </div>
            </div>
          </div>

          <div class="arena" id="arena" onclick="onArenaMiss(event)">
            <div class="arena-grid"></div>
            <svg class="arena-bg-map" viewBox="0 0 400 600" preserveAspectRatio="none">
              <path fill="none" stroke="rgba(255,255,255,0.03)" stroke-width="2"
                d="M0,100 Q100,50 200,100 T400,100 M0,300 Q100,250 200,300 T400,300 M0,500 Q100,450 200,500 T400,500 M100,0 Q50,150 100,300 T100,600 M300,0 Q250,150 300,300 T300,600" />
            </svg>
            <div class="toast" id="toast">Ready?</div>
            <div id="gps-lock" class="gps-lock-overlay">
              <div class="gps-spinner"></div>
              <div class="tag">Searching for GPS...</div>
            </div>
          </div>

          <div class="anchor-zone">
            <button class="anchor-btn" id="anchor-btn" onclick="onAnchorClick()">START</button>
          </div>
        </div>

        <!-- SCREEN 4 -->
        <div class="screen hidden" id="s4">
          <div class="results-head" style="padding-bottom: 12px;">
            <div class="res-eyebrow">Session Complete</div>
            <h2 class="res-title">Summary</h2>
          </div>

          <div id="pb-celebration" class="pb-badge">Personal Record</div>

          <div class="map-placeholder">
            <svg class="gps-path" viewBox="0 0 400 200" preserveAspectRatio="none">
              <path class="gps-line" d="M 50,150 C 100,140 80,100 150,80 S 200,120 280,60 C 330,20 380,40 380,40" />
              <circle class="gps-marker" cx="50" cy="150" r="4" />
              <circle class="gps-marker end" cx="380" cy="40" r="4" />
            </svg>
          </div>

          <div class="results-stats" style="padding-bottom: 20px;">
            <div class="res-card wide">
              <div class="res-val" id="r-avg">--</div>
              <div class="res-lbl">Average Movement Time</div>
            </div>
            <div class="res-card">
              <div class="res-val" id="r-total">--</div>
              <div class="res-lbl">Total Hits</div>
            </div>
            <div class="res-card">
              <div class="res-val" id="r-acc">100%</div>
              <div class="res-lbl">Accuracy</div>
            </div>
          </div>

          <div class="section-label" style="padding: 0 26px; margin-top: 10px;">Trial Splits</div>
          <div class="splits-grid">
            <div class="split-row">
              <span class="split-name">Large (50px)</span>
              <span class="split-val" id="s-large">--</span>
            </div>
            <div class="split-row">
              <span class="split-name">Medium (34px)</span>
              <span class="split-val" id="s-medium">--</span>
            </div>
            <div class="split-row">
              <span class="split-name">Small (22px)</span>
              <span class="split-val" id="s-small">--</span>
            </div>
          </div>

          <div class="section-label" style="padding: 0 26px; margin-top: 20px;">Precision Map</div>
          <div id="v3-heatmap"
            style="height: 100px; margin: 0 26px; border: 1px solid rgba(255,255,255,0.05); background: rgba(0,0,0,0.2); position: relative; border-radius: 4px; overflow: hidden;">
            <!-- Heatmap via JS -->
          </div>

          <div class="section-label" style="padding: 0 26px; margin-top: 20px;">Efficiency Profile</div>
          <div id="fitts-plot-v3"
            style="height: 100px; margin: 0 26px; border: 1px solid rgba(255,255,255,0.05); background: rgba(0,0,0,0.2); position: relative; overflow: hidden;">
            <!-- Scatter Plot via JS -->
            <div style="position: absolute; bottom: 4px; right: 4px; font-size: 8px; color: rgba(255,255,255,0.2);">ID â†’
            </div>
          </div>

          <div id="coach-ai-v3"
            style="margin: 16px 26px; padding: 12px; border-left: 2px solid #FC4C02; background: rgba(252, 76, 2, 0.05); font-size: 11px; line-height: 1.4; color: #ddd;">
            <div
              style="font-weight: 900; color: #FC4C02; font-size: 9px; margin-bottom: 4px; text-transform: uppercase;">
              Coach AI Performance Delta</div>
            <span id="coach-txt-v3">Calculating segment dynamics...</span>
          </div>

          <div style="padding: 0 26px 40px; display: flex; gap: 12px;">
            <button class="cta-btn" style="flex: 1;" onclick="initArena(); goTo('s3');">Retry Trial</button>
            <button class="cta-btn" style="flex: 1; border: 2px solid #FC4C02; background: transparent; color: #FC4C02;"
              onclick="exportSegment()">Export Segment</button>
          </div>
        </div>

      </div>
    </div>
  </div>

  <script>
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• LOGIC â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    const BTN_CONFIG = [
      { id: 1, label: 'L1', type: 'large', xPct: 0.2, yPct: 0.2 },
      { id: 2, label: 'L2', type: 'large', xPct: 0.8, yPct: 0.3 },
      { id: 3, label: 'L3', type: 'large', xPct: 0.5, yPct: 0.7 },
      { id: 4, label: 'M1', type: 'medium', xPct: 0.15, yPct: 0.5 },
      { id: 5, label: 'M2', type: 'medium', xPct: 0.85, yPct: 0.6 },
      { id: 6, label: 'M3', type: 'medium', xPct: 0.3, yPct: 0.85 },
      { id: 7, label: 'S1', type: 'small', xPct: 0.7, yPct: 0.15 },
      { id: 8, label: 'S2', type: 'small', xPct: 0.5, yPct: 0.4 }
    ];

    const SZ = { large: 50, medium: 34, small: 22 };

    let sequence = [];
    let currentIdx = 0;
    let timings = { large: [], medium: [], small: [] };
    let misses = 0;
    let startTime = 0;
    let expState = 'idle';
    let bpm = 120;
    let bpmInterval = null;
    let combo = 0;
    let diffMult = 1.0;

    let cumTimes = [];
    const urlParams = new URLSearchParams(window.location.search);
    const isGP = urlParams.get('gp') === 'true';
    const gpSeed = parseInt(urlParams.get('seed') || '0');

    function seededShuffle(arr, seed) {
      const rand = mulberry32(seed);
      let a = [...arr];
      for (let i = a.length - 1; i > 0; i--) {
        const j = Math.floor(rand() * (i + 1));
        [a[i], a[j]] = [a[j], a[i]];
      }
      return a;
    }

    function mulberry32(a) {
      return function () {
        var t = a += 0x6D2B79F5;
        t = Math.imul(t ^ t >>> 15, t | 1);
        t ^= t + Math.imul(t ^ t >>> 7, t | 61);
        return ((t ^ t >>> 14) >>> 0) / 4294967296;
      }
    }

    function shuffle(arr) {
      return [...arr].sort(() => Math.random() - 0.5);
    }

    function goTo(id) {
      document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
      const active = document.getElementById(id);
      active.classList.remove('hidden');

      // Heart rate display logic
      document.getElementById('bpm-display').style.display = (id === 's3') ? 'flex' : 'none';
      if (id !== 's3') stopBpm();
    }

    function startExperiment() {
      initArena();
      goTo('s3');

      // GPS Lock simulation
      const lock = document.getElementById('gps-lock');
      lock.classList.add('active');
      setTimeout(() => {
        lock.classList.remove('active');
        startBpm();
      }, 1200);
    }

    function initArena() {
      if (isGP) {
        sequence = seededShuffle(BTN_CONFIG, gpSeed);
        document.querySelector('.hero-title').textContent = "GRAND PRIX";
      } else {
        sequence = shuffle(BTN_CONFIG);
      }

      currentIdx = 0;
      misses = 0;
      cumTimes = [];
      timings = { large: [], medium: [], small: [] };
      bpm = 120;
      expState = 'wait-anchor';

      const pbCum = JSON.parse(localStorage.getItem('fitts_pb_cum_v3') || '[]');
      if (pbCum.length) document.getElementById('v3-ghost-pill').style.display = 'flex';
      else document.getElementById('v3-ghost-pill').style.display = 'none';


      document.getElementById('hit-count').textContent = '0';
      document.getElementById('live-pace').textContent = 'â€”';
      document.getElementById('p-bar').style.width = '0%';
      setToast('READY');

      document.getElementById('anchor-btn').classList.add('waiting');
      buildButtons();
    }

    function buildButtons() {
      const arena = document.getElementById('arena');
      arena.querySelectorAll('.tgt').forEach(b => b.remove());

      const W = arena.offsetWidth || 342;
      const H = arena.offsetHeight || 500;

      sequence.forEach(cfg => {
        const btn = document.createElement('div');
        btn.className = 'tgt pulse';
        btn.id = `eb-${cfg.id}`;
        btn.textContent = cfg.label;

        const s = SZ[cfg.type] * diffMult;
        btn.style.width = s + 'px';
        btn.style.height = s + 'px';
        btn.style.left = (cfg.xPct * W - s / 2) + 'px';
        btn.style.top = (cfg.yPct * H - s / 2) + 'px';

        btn.onclick = (e) => {
          e.stopPropagation();
          onExpClick(e, cfg.id, cfg.type, btn);
        };
        arena.appendChild(btn);
      });
    }

    function onArenaMiss(e) {
      if (expState === 'wait-target') {
        misses++;
        // Visual feedback for miss
        const arena = document.getElementById('arena');
        arena.style.background = 'rgba(255, 0, 0, 0.05)';
        setTimeout(() => arena.style.background = '#000', 100);
      }
    }

    let drift = { x: 0, y: 0, vx: 0, vy: 0 };
    let driftFrame = null;

    function startDrift(targetId) {
      const btn = document.getElementById(`eb-${targetId}`);
      if (!btn) return;

      // Random initial velocity
      drift.vx = (Math.random() - 0.5) * 4;
      drift.vy = (Math.random() - 0.5) * 4;

      const update = () => {
        if (expState !== 'wait-target') return;

        let x = parseFloat(btn.style.left);
        let y = parseFloat(btn.style.top);

        x += drift.vx;
        y += drift.vy;

        // Bounce off arena walls
        const arena = document.getElementById('arena');
        const W = arena.offsetWidth;
        const H = arena.offsetHeight;
        const s = parseFloat(btn.style.width);

        if (x < 0 || x > W - s) drift.vx *= -1;
        if (y < 0 || y > H - s) drift.vy *= -1;

        btn.style.left = x + 'px';
        btn.style.top = y + 'px';

        driftFrame = requestAnimationFrame(update);
      };
      driftFrame = requestAnimationFrame(update);
    }

    function onAnchorClick() {
      if (expState !== 'wait-anchor') return;
      document.getElementById('anchor-btn').classList.remove('waiting');

      const target = sequence[currentIdx];
      const btn = document.getElementById(`eb-${target.id}`);
      btn.classList.add('active-t');

      startTime = performance.now();
      expState = 'wait-target';
      setToast('');

      startDrift(target.id);
    }

    function onExpClick(e, id, type, btn) {
      if (expState !== 'wait-target') return;

      const elapsed = Math.round(performance.now() - startTime);

      // Adaptive difficulty logic (v6.7)
      if (elapsed < 500) {
        combo++;
        if (combo % 3 === 0) {
          diffMult = Math.max(0.6, diffMult - 0.05); // Shrink targets for pros
          setToast(`COMBO ${combo}! SPEED BOOST: -5% SIZE`);
        }
      } else if (elapsed > 800) {
        combo = 0;
        diffMult = Math.min(1.2, diffMult + 0.05); // Grow targets to help
        setToast(`PACE DECAY. RECOVERING PRECISION.`);
      }

      // Calculate actual distance at moment of click
      const anchor = document.getElementById('anchor-btn').getBoundingClientRect();
      const targetRect = btn.getBoundingClientRect();
      const clickX = e ? (e.clientX - targetRect.left) / targetRect.width : 0.5;
      const clickY = e ? (e.clientY - targetRect.top) / targetRect.height : 0.5;

      timings[type].push({ mt: elapsed, dist, size: SZ[type], clickX, clickY });
      cumTimes.push((cumTimes.length ? cumTimes[cumTimes.length - 1] : 0) + elapsed);
      updateGhostPace();

      // Visual feedback
      createRipple(e, btn);
      createBadge(btn, elapsed + 'ms');

      btn.classList.remove('active-t');
      currentIdx++;

      // Stats & Progress
      const allTimings = Object.values(timings).flat().map(t => t.mt);
      const avg = Math.round(allTimings.reduce((a, b) => a + b, 0) / allTimings.length);
      document.getElementById('hit-count').textContent = currentIdx;
      document.getElementById('live-pace').textContent = elapsed + 'ms';
      document.getElementById('p-bar').style.width = (currentIdx / sequence.length * 100) + '%';

      if (currentIdx < sequence.length) {
        expState = 'wait-anchor';

        // Update next button size (Adaptive v6.7)
        const next = sequence[currentIdx];
        const nextBtn = document.getElementById(`eb-${next.id}`);
        const s = SZ[next.type] * diffMult;
        nextBtn.style.width = s + 'px';
        nextBtn.style.height = s + 'px';

        document.getElementById('anchor-btn').classList.add('waiting');
        setToast('RETURN');
        bpm += 2; // Increase heart rate
      } else {
        showResults();
      }
    }

    function showResults() {
      expState = 'done';
      stopBpm();

      const allData = Object.values(timings).flat();
      const allTimes = allData.map(t => t.mt);
      const avg = Math.round(allTimes.reduce((a, b) => a + b, 0) / allTimes.length);
      const acc = Math.round((allData.length / (allData.length + misses)) * 100);

      // Update Summaries
      document.getElementById('r-avg').textContent = avg + 'ms';
      document.getElementById('r-total').textContent = allData.length;
      document.getElementById('r-acc').textContent = acc + '%';

      // Update Splits
      ['large', 'medium', 'small'].forEach(key => {
        const arr = timings[key].map(t => t.mt);
        const val = arr.length > 0 ? Math.round(arr.reduce((a, b) => a + b, 0) / arr.length) + 'ms' : '--';
        document.getElementById(`s-${key}`).textContent = val;
      });

      // â”€â”€ FITTS PLOT & COACH AI (v6.3) â”€â”€
      const plot = document.getElementById('fitts-plot-v3');
      plot.querySelectorAll('.dot').forEach(d => d.remove());

      const sessionData = allData.map(d => {
        const id = Math.log2((2 * d.dist) / d.size);
        return { id, mt: d.mt };
      });

      const maxID = Math.max(...sessionData.map(d => d.id), 5);
      const minID = Math.min(...sessionData.map(d => d.id), 1);
      const maxMT = Math.max(...sessionData.map(d => d.mt), 1000);

      sessionData.forEach(d => {
        const dot = document.createElement('div');
        dot.className = 'dot';
        const left = ((d.id - minID) / (maxID - minID)) * 90 + 5;
        const bottom = (d.mt / maxMT) * 90 + 5;
        dot.style.cssText = `position:absolute; bottom:${bottom}%; left:${left}%; width:5px; height:5px; background:#FC4C02; border-radius:50%; box-shadow:0 0 8px rgba(252, 76, 2, 0.4);`;
        plot.appendChild(dot);
      });

      // Coach AI
      const topSpeed = Math.min(...allTimes);
      let coachTxt = "";
      if (avg < 500 && acc >= 98) coachTxt = "SEGMENT LEADER: Movement efficiency is world-class. You are effectively counter-steering target drift with zero overshoot.";
      else if (acc < 90) coachTxt = "CAUTION: Target drift is causing ballistic errors. Your precision is dropping below segment safety levels. Reduce heart rate.";
      else coachTxt = "SOLID EFFORT: Your movement profiles show consistent linear tracking. To improve, focus on the 'snap' to target before the drift accelerates.";
      document.getElementById('coach-txt-v3').innerHTML = coachTxt;

      // DRAW HEATMAP (v6.7)
      const hm = document.getElementById('v3-heatmap');
      hm.querySelectorAll('.hm-dot-v3').forEach(d => d.remove());
      allData.forEach(d => {
        if (d.clickX !== undefined) {
          const dot = document.createElement('div');
          dot.className = 'hm-dot-v3';
          dot.style.cssText = `position:absolute; left:${d.clickX * 100}%; top:${d.clickY * 100}%; width:5px; height:5px; background:#FC4C02; border-radius:50%; transform:translate(-50%,-50%); box-shadow:0 0 10px rgba(252, 76, 2, 0.4);`;
          hm.appendChild(dot);
        }
      });

      // Personal Best check
      const prevBest = localStorage.getItem('fitts_pb_strava');
      const pbBadge = document.getElementById('pb-celebration');
      if (!prevBest || avg < parseInt(prevBest)) {
        localStorage.setItem('fitts_pb_strava', avg);
        pbBadge.classList.add('active');
      } else {
        pbBadge.classList.remove('active');
      }

      // LEADERBOARD LOGGING (v4.2)
      const userName = localStorage.getItem('fitts_user_name') || 'Guest Athlete';
      const leaderboard = JSON.parse(localStorage.getItem('fitts_leaderboard') || '[]');

      const entryBadges = [];
      let beatMessage = "";

      // ğŸ† First Blood
      if (leaderboard.length === 0) {
        entryBadges.push("First Blood");
      }

      // ğŸ¯ Sniper
      if (acc === 100) {
        entryBadges.push("Sniper");
      }

      // Sort existing to find rank
      const sortedPrev = [...leaderboard].sort((a, b) => a.avg - b.avg);

      // ğŸ‘‘ Segment Leader / Beat logic
      if (sortedPrev.length > 0) {
        if (avg < sortedPrev[0].avg) {
          entryBadges.push("Leader");
          if (sortedPrev[0].name !== userName) {
            beatMessage = `You beat ${sortedPrev[0].name}!`;
          }
        } else {
          // Find the person just above you
          const beaten = sortedPrev.find(e => avg < e.avg && e.name !== userName);
          if (beaten) {
            beatMessage = `You beat ${beaten.name}!`;
          }
        }
      }

      // XP CALCULATION (v6.0)
      const baseXP = 100;
      const accXP = acc * 5;
      const speedXP = Math.max(0, Math.round((1000 - avg) / 2));
      const totalXP = Math.round((baseXP + accXP + speedXP) * 2.0); // V3 multiplier: 2.0

      const currentXP = parseInt(localStorage.getItem('fitts_xp') || '0');
      localStorage.setItem('fitts_xp', currentXP + totalXP);

      const newEntry = {
        name: userName,
        avg: avg,
        acc: acc,
        date: new Date().toISOString(),
        badges: entryBadges,
        beat: beatMessage,
        version: "v3",
        hw: localStorage.getItem('fitts_hardware') || 'mouse',
        xpGain: totalXP,
        fittsData: sessionData
      };

      leaderboard.push(newEntry);
      localStorage.setItem('fitts_leaderboard', JSON.stringify(leaderboard));

      // Update Cumulative PB (v6.5)
      const prevPBCum = JSON.parse(localStorage.getItem('fitts_pb_cum_v3') || '[]');
      if (!prevPBCum.length || cumTimes[cumTimes.length - 1] < prevPBCum[prevPBCum.length - 1]) {
        localStorage.setItem('fitts_pb_cum_v3', JSON.stringify(cumTimes));
      }

      // Visual feedback for beat message
      if (beatMessage) {
        setToast(beatMessage.toUpperCase());
        setTimeout(() => setToast(""), 3000);
      }

      goTo('s4');
    }

    function startBpm() {
      bpm = 110;
      bpmInterval = setInterval(() => {
        bpm += (Math.random() > 0.5 ? 1 : -1);
        document.getElementById('bpm-val').textContent = bpm;
      }, 800);
    }

    function stopBpm() {
      if (bpmInterval) clearInterval(bpmInterval);
    }

    function setToast(txt) {
      document.getElementById('toast').textContent = txt;
    }

    function createRipple(e, parent) {
      const r = document.createElement('div');
      r.className = 'ripple';
      const rect = parent.getBoundingClientRect();
      r.style.width = r.style.height = Math.max(rect.width, rect.height) + 'px';
      r.style.left = '0'; r.style.top = '0';
      parent.appendChild(r);
      setTimeout(() => r.remove(), 600);
    }

    function createBadge(parent, txt) {
      const b = document.createElement('div');
      b.className = 'time-badge';
      b.textContent = txt;
      b.style.left = '50%'; b.style.top = '-20px';
      b.style.transform = 'translateX(-50%)';
      parent.appendChild(b);
      setTimeout(() => b.remove(), 800);
    }
    function exportSegment() {
      const allTrials = [];
      Object.keys(timings).forEach(size => {
        timings[size].forEach((time, idx) => {
          allTrials.push({ size, time, index: idx });
        });
      });

      const data = {
        athlete: localStorage.getItem('fitts_user_name') || 'Guest',
        hardware: localStorage.getItem('fitts_hardware') || 'mouse',
        timestamp: new Date().toISOString(),
        version: 'v3',
        metrics: {
          avgMT: document.getElementById('r-avg').textContent,
          acc: document.getElementById('r-acc').textContent,
          targets: document.getElementById('r-total').textContent
        },
        trials: allTrials
      };

      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `fitts_segment_v3_${Date.now()}.json`;
      a.click();
      URL.revokeObjectURL(url);
    }
    function updateGhostPace() {
      const pbTimes = JSON.parse(localStorage.getItem('fitts_pb_cum_v3') || '[]');
      if (!pbTimes.length) return;

      const delta = document.getElementById('v3-ghost-delta');
      const currentCum = cumTimes[cumTimes.length - 1];
      const pbCum = pbTimes[cumTimes.length - 1];
      const diff = (currentCum - pbCum) / 1000;

      delta.textContent = (diff <= 0 ? '' : '+') + diff.toFixed(2) + 's';
      delta.style.color = diff <= 0 ? '#4CD964' : '#FF3B30';
    }
  </script>
</body>

</html>

</html>