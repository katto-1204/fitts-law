<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Viper Command — Integrated Data Station</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link
    href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Bebas+Neue&family=Outfit:wght@200;400;900&display=swap"
    rel="stylesheet">
  <style>
    :root {
      --bg: #0A0518;
      --card: #150E2D;
      --accent: #A855F7;
      --accent-glow: rgba(168, 85, 247, 0.4);
      --text: #F3E8FF;
      --muted: #A78BFA;
      --border: rgba(168, 85, 247, 0.2);
      --font-mono: 'Space Mono', monospace;
      --font-display: 'Bebas Neue', sans-serif;
      --font-body: 'Outfit', sans-serif;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: var(--font-body);
      height: 100vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    /* ═══════════════════════════════════════════════════
       HOLOGRAPHIC BACKGROUND
    ═══════════════════════════════════════════════════ */
    .bg-fx {
      position: fixed;
      inset: 0;
      z-index: -1;
      background: radial-gradient(circle at 50% 50%, #1A0B3B 0%, #0A0518 100%);
    }

    .bg-grid {
      position: fixed;
      inset: 0;
      z-index: -1;
      background-image:
        linear-gradient(var(--border) 1px, transparent 1px),
        linear-gradient(90deg, var(--border) 1px, transparent 1px);
      background-size: 80px 80px;
      opacity: 0.3;
      transform: perspective(500px) rotateX(20deg) scale(2);
      transform-origin: top;
      animation: grid-scroll 20s linear infinite;
    }

    @keyframes grid-scroll {
      from {
        background-position: 0 0;
      }

      to {
        background-position: 0 800px;
      }
    }

    /* ═══════════════════════════════════════════════════
       HEADER & HUD
    ═══════════════════════════════════════════════════ */
    .hud-header {
      height: 60px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      padding: 0 40px;
      gap: 20px;
      background: rgba(15, 10, 31, 0.8);
      backdrop-filter: blur(10px);
    }

    .hud-logo {
      font-family: var(--font-display);
      font-size: 28px;
      letter-spacing: 2px;
      color: var(--accent);
      text-shadow: 0 0 10px var(--accent-glow);
    }

    .status-group {
      display: flex;
      gap: 24px;
      margin-left: auto;
      font-family: var(--font-mono);
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .status-item span {
      color: var(--muted);
      margin-right: 6px;
    }

    /* ═══════════════════════════════════════════════════
       DASHBOARD LAYOUT
    ═══════════════════════════════════════════════════ */
    .main-deck {
      flex: 1;
      display: grid;
      grid-template-columns: 320px 1fr 320px;
      gap: 24px;
      padding: 24px;
      max-width: 1600px;
      margin: 0 auto;
      width: 100%;
    }

    .panel {
      background: rgba(21, 14, 45, 0.6);
      border: 1px solid var(--border);
      border-radius: 12px;
      backdrop-filter: blur(20px);
      display: flex;
      flex-direction: column;
      padding: 24px;
      position: relative;
      overflow: hidden;
    }

    .panel-label {
      font-family: var(--font-mono);
      font-size: 10px;
      color: var(--accent);
      margin-bottom: 20px;
      letter-spacing: 2px;
      text-transform: uppercase;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .panel-label::after {
      content: '';
      height: 1px;
      flex: 1;
      background: var(--border);
    }

    /* ═══════════════════════════════════════════════════
       ARENA (CENTER)
    ═══════════════════════════════════════════════════ */
    .arena-panel {
      padding: 0;
      overflow: hidden;
      border-color: var(--accent);
      box-shadow: inset 0 0 50px rgba(168, 85, 247, 0.1);
    }

    #arena {
      width: 100%;
      height: 100%;
      position: relative;
      background: rgba(0, 0, 0, 0.2);
    }

    .scanline {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 2px;
      background: rgba(168, 85, 247, 0.15);
      z-index: 10;
      animation: scan 4s linear infinite;
    }

    @keyframes scan {
      from {
        top: -2%;
      }

      to {
        top: 102%;
      }
    }

    /* Targets */
    .tgt {
      position: absolute;
      border-radius: 50%;
      background: transparent;
      border: 1px solid var(--muted);
      cursor: pointer;
      opacity: 0.2;
      transition: all 0.2s;
      display: flex;
      outline: none;
      align-items: center;
      justify-content: center;
      font-family: var(--font-mono);
      font-weight: 700;
      pointer-events: none;
    }

    .tgt.active-t {
      opacity: 1;
      border-color: #fff;
      background: var(--accent);
      box-shadow: 0 0 30px var(--accent-glow), 0 0 10px #fff;
      pointer-events: all;
      transform: scale(1.1);
    }

    /* Anchor button */
    .anchor-btn {
      position: absolute;
      bottom: 40px;
      left: 50%;
      transform: translateX(-50%);
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: #000;
      border: 2px solid var(--border);
      color: #fff;
      font-family: var(--font-display);
      font-size: 18px;
      cursor: pointer;
      z-index: 100;
      transition: all 0.3s;
    }

    .anchor-btn.waiting {
      border-color: var(--accent);
      background: var(--surface2);
      box-shadow: 0 0 20px var(--accent-glow);
      animation: pulse 1s infinite alternate;
    }

    @keyframes pulse {
      from {
        opacity: 0.7;
        transform: translateX(-50%) scale(0.95);
      }

      to {
        opacity: 1;
        transform: translateX(-50%) scale(1.05);
      }
    }

    /* ═══════════════════════════════════════════════════
       TELEMETRY (LEFT)
    ═══════════════════════════════════════════════════ */
    .telemetry-row {
      margin-bottom: 32px;
    }

    .tel-val {
      font-size: 48px;
      font-weight: 900;
      line-height: 1;
      color: var(--accent);
    }

    .tel-lbl {
      font-size: 11px;
      font-family: var(--font-mono);
      color: var(--muted);
      text-transform: uppercase;
      margin-top: 4px;
    }

    .mini-chart {
      height: 60px;
      display: flex;
      align-items: flex-end;
      gap: 2px;
      margin-top: 12px;
    }

    .chart-bar {
      flex: 1;
      background: var(--muted);
      opacity: 0.3;
      transition: height 0.5s;
    }

    /* ═══════════════════════════════════════════════════
       MISSION LOG (RIGHT)
    ═══════════════════════════════════════════════════ */
    .log-list {
      flex: 1;
      font-family: var(--font-mono);
      font-size: 11px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .log-item {
      display: flex;
      gap: 10px;
      color: var(--muted2);
    }

    .log-item.active {
      color: var(--text);
    }

    .log-item.done {
      color: var(--accent);
    }

    .log-item b {
      color: var(--accent);
    }

    /* ═══════════════════════════════════════════════════
       DATA OVERLAYS
    ═══════════════════════════════════════════════════ */
    .overlay {
      position: absolute;
      inset: 0;
      z-index: 500;
      background: rgba(10, 5, 24, 0.95);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 40px;
    }

    .overlay.hidden {
      display: none;
    }

    .modal {
      width: 100%;
      max-width: 600px;
      text-align: center;
    }

    .modal h2 {
      font-family: var(--font-display);
      font-size: 64px;
      color: var(--accent);
      margin-bottom: 12px;
    }

    .modal p {
      color: var(--muted);
      margin-bottom: 32px;
      font-size: 18px;
    }

    .btn-action {
      padding: 20px 48px;
      background: var(--accent);
      color: #fff;
      border: none;
      font-family: var(--font-display);
      font-size: 24px;
      cursor: pointer;
      letter-spacing: 2px;
      transition: all 0.2s;
    }

    .btn-action:hover {
      transform: scale(1.05);
      box-shadow: 0 0 30px var(--accent-glow);
    }

    /* Splits */
    .splits-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
      margin: 32px 0;
    }

    .split-card {
      background: var(--surface);
      border: 1px solid var(--border);
      padding: 20px;
      border-radius: 8px;
    }

    .split-val {
      font-size: 24px;
      font-weight: 900;
      color: var(--accent);
    }

    .split-lbl {
      font-size: 10px;
      font-family: var(--font-mono);
      color: var(--muted);
    }

    /* Footer return */
    .back-home {
      position: fixed;
      bottom: 24px;
      right: 24px;
      color: var(--muted);
      font-family: var(--font-mono);
      font-size: 11px;
      text-decoration: none;
      text-transform: uppercase;
      letter-spacing: 2px;
    }

    @media (max-width: 1200px) {
      .main-deck {
        grid-template-columns: 1fr;
        grid-template-rows: auto 1fr auto;
        height: auto;
        overflow: visible;
      }

      body {
        overflow-y: auto;
        height: auto;
      }

      .panel {
        height: 400px;
      }
    }
  </style>
</head>

<body>

  <div class="bg-fx"></div>
  <div class="bg-grid"></div>

  <header class="hud-header">
    <div class="hud-logo">VIPER COMMAND</div>
    <div class="status-group">
      <div class="status-item"><span>SECTOR:</span> V2-PURPLE</div>
      <div class="status-item"><span>DIFFICULTY:</span> AVERAGE</div>
      <div class="status-item"><span>STATUS:</span> <b id="status-txt">ACTIVE</b></div>
    </div>
  </header>

  <main class="main-deck">
    <!-- Left: Telemetry -->
    <aside class="panel">
      <div class="panel-label">Telemetry</div>

      <div class="telemetry-row">
        <div class="tel-val" id="hit-count">0</div>
        <div class="tel-lbl">Targets Captured</div>
      </div>

      <div class="telemetry-row">
        <div class="tel-val" id="avg-time">—</div>
        <div class="tel-lbl">Avg Response (ms)</div>
        <div class="mini-chart" id="chart-container">
          <!-- Bars generated via JS -->
          <div class="chart-bar" style="height: 20%"></div>
          <div class="chart-bar" style="height: 40%"></div>
          <div class="chart-bar" style="height: 30%"></div>
          <div class="chart-bar" style="height: 60%"></div>
        </div>
      </div>

      <div class="telemetry-row" style="margin-top: auto;">
        <div class="tel-val" style="font-size: 24px;">98.2%</div>
        <div class="tel-lbl">System Precision</div>
      </div>
    </aside>

    <!-- Center: Arena -->
    <section class="panel arena-panel">
      <div class="scanline"></div>
      <div id="arena">
        <button id="anchor-btn" class="anchor-btn waiting" onclick="onAnchorClick()">START</button>
      </div>
    </section>

    <!-- Right: Mission Log -->
    <aside class="panel">
      <div class="panel-label">Mission Log</div>
      <div class="log-list" id="mission-log">
        <div class="log-item active">Initializing tactical arena...</div>
        <div class="log-item">Awaiting pilot authorization...</div>
        <div class="log-item">Standard movement benchmarks active.</div>
      </div>

      <div class="panel-label" style="margin-top: 40px;">Hardware</div>
      <div style="font-size: 12px; color: var(--muted2); font-family: var(--font-mono);">
        [SZ: L44, M28, S16]<br>
        [CALIBRATION: PASSED]
      </div>
    </aside>
  </main>

  <!-- START OVERLAY -->
  <div id="start-overlay" class="overlay">
    <div class="modal">
      <h2>PURPLE ARENA</h2>
      <p>High-precision diagnostic workstation. Average difficulty. Cyber-Viper calibration enabled.</p>
      <button class="btn-action" onclick="closeOverlay('start-overlay')">INITIALIZE</button>
    </div>
  </div>

  <!-- RESULTS OVERLAY -->
  <div id="results-overlay" class="overlay hidden">
    <div class="modal">
      <h2>RECAP COMPLETE</h2>
      <div class="splits-grid">
        <div class="split-card">
          <div class="split-val" id="r-avg">—</div>
          <div class="split-lbl">AVG TIME</div>
        </div>
        <div class="split-card">
          <div class="split-val" id="r-acc">—</div>
          <div class="split-lbl">ACCURACY</div>
        </div>
        <div class="split-card">
          <div class="split-val" id="r-total">—</div>
          <div class="split-lbl">TARGETS</div>
        </div>
      </div>
      <button class="btn-action" onclick="location.reload()">RE-CALIBRATE</button>
      <a href="index.html" class="btn-action"
        style="background: transparent; color: var(--muted); border: 1px solid var(--border); display: block; margin-top: 12px; text-decoration: none; padding: 12px;">EXIT
        TO BASE</a>
    </div>
  </div>

  <a href="index.html" class="back-home">← Return to Base</a>

  <script>
    const BTN_CONFIG = [
      { id: 'L1', type: 'large', xPct: 0.50, yPct: 0.15, label: '01' },
      { id: 'L2', type: 'large', xPct: 0.15, yPct: 0.40, label: '02' },
      { id: 'L3', type: 'large', xPct: 0.85, yPct: 0.30, label: '03' },
      { id: 'M1', type: 'medium', xPct: 0.80, yPct: 0.70, label: '04' },
      { id: 'M2', type: 'medium', xPct: 0.25, yPct: 0.75, label: '05' },
      { id: 'M3', type: 'medium', xPct: 0.55, yPct: 0.50, label: '06' },
      { id: 'S1', type: 'small', xPct: 0.10, yPct: 0.15, label: '07' },
      { id: 'S2', type: 'small', xPct: 0.90, yPct: 0.85, label: '08' },
    ];

    const SZ = { large: 44, medium: 28, small: 16 };
    let sequence = [];
    let currentIdx = 0;
    let startTime = 0;
    let timings = { large: [], medium: [], small: [] };
    let misses = 0;
    let expState = 'idle'; // idle | wait-anchor | run

    function closeOverlay(id) {
      document.getElementById(id).classList.add('hidden');
      if (id === 'start-overlay') initArena();
    }

    function initArena() {
      const arena = document.getElementById('arena');
      arena.querySelectorAll('.tgt').forEach(t => t.remove());

      sequence = [...BTN_CONFIG].sort(() => Math.random() - 0.5);
      currentIdx = 0;
      timings = { large: [], medium: [], small: [] };
      misses = 0;
      expState = 'wait-anchor';

      addLog('Arena initialized. Ready for calibration.');
      buildTargets();
    }

    function buildTargets() {
      const arena = document.getElementById('arena');
      const W = arena.offsetWidth;
      const H = arena.offsetHeight;

      sequence.forEach(cfg => {
        const btn = document.createElement('div');
        btn.className = 'tgt';
        btn.id = `eb-${cfg.id}`;
        btn.textContent = cfg.label;

        const s = SZ[cfg.type];
        btn.style.width = s + 'px';
        btn.style.height = s + 'px';
        btn.style.left = (cfg.xPct * W - s / 2) + 'px';
        btn.style.top = (cfg.yPct * H - s / 2) + 'px';

        btn.onclick = (e) => {
          e.stopPropagation();
          onExpClick(cfg.id, cfg.type, btn);
        };
        arena.appendChild(btn);
      });
    }

    function onAnchorClick() {
      if (expState !== 'wait-anchor') return;
      expState = 'run';
      document.getElementById('anchor-btn').classList.remove('waiting');
      addLog(`Mission started. Capturing target ${sequence[currentIdx].label}...`);
      showNext();
    }

    function showNext() {
      if (currentIdx >= sequence.length) {
        endExperiment();
        return;
      }
      const target = sequence[currentIdx];

      // Dim all
      document.querySelectorAll('.tgt').forEach(t => {
        t.classList.remove('active-t');
      });

      const tEl = document.getElementById(`eb-${target.id}`);
      tEl.classList.add('active-t');
      startTime = performance.now();
    }

    function onExpClick(id, type, btn) {
      if (expState !== 'run') return;
      if (id !== sequence[currentIdx].id) return;

      const ms = Math.round(performance.now() - startTime);
      timings[type].push(ms);

      addLog(`Target ${sequence[currentIdx].label} captured in ${ms}ms.`, 'done');

      currentIdx++;
      updateStats();

      if (currentIdx < sequence.length) {
        expState = 'wait-anchor';
        document.getElementById('anchor-btn').classList.add('waiting');
      } else {
        endExperiment();
      }
    }

    function updateStats() {
      const all = Object.values(timings).flat();
      const avg = Math.round(all.reduce((a, b) => a + b, 0) / all.length);
      document.getElementById('hit-count').textContent = all.length;
      document.getElementById('avg-time').textContent = avg;

      // Update mini chart
      const chartRows = document.getElementById('chart-container');
      const latest = all[all.length - 1];
      const bar = document.createElement('div');
      bar.className = 'chart-bar';
      bar.style.height = (Math.min(latest / 10, 100)) + '%';
      bar.style.opacity = '1';
      chartRows.appendChild(bar);
      if (chartRows.children.length > 20) chartRows.removeChild(chartRows.firstChild);
    }

    function addLog(msg, status = '') {
      const log = document.getElementById('mission-log');
      const item = document.createElement('div');
      item.className = 'log-item' + (status ? ' ' + status : ' active');
      item.innerHTML = `<span>[${new Date().toLocaleTimeString('en-GB', { hour12: false })}]</span> ${msg}`;
      log.prepend(item);
      if (log.children.length > 15) log.lastChild.remove();
    }

    function endExperiment() {
      expState = 'done';
      document.getElementById('status-txt').textContent = 'RECAP';
      document.getElementById('results-overlay').classList.remove('hidden');

      const all = Object.values(timings).flat();
      const avgVal = Math.round(all.reduce((a, b) => a + b, 0) / all.length);
      const acc = Math.round((all.length / (all.length + misses)) * 100);

      document.getElementById('r-avg').textContent = avgVal + 'ms';
      document.getElementById('r-acc').textContent = acc + '%';
      document.getElementById('r-total').textContent = all.length;

      // Persistence
      const userName = localStorage.getItem('fitts_user_name') || 'Guest Athlete';
      const leaderboard = JSON.parse(localStorage.getItem('fitts_leaderboard') || '[]');
      leaderboard.push({
        name: userName,
        avg: avgVal,
        acc: acc,
        date: new Date().toISOString(),
        version: "v2"
      });
      localStorage.setItem('fitts_leaderboard', JSON.stringify(leaderboard));
    }

    // Arena Miss
    document.getElementById('arena').onclick = () => {
      if (expState === 'run') {
        misses++;
        addLog('ARENA MISS REGISTERED', 'failed');
      }
    };
  </script>
</body>

</html>