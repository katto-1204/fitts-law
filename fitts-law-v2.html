<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Viper Command — Integrated Data Station</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link
    href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Bebas+Neue&family=Outfit:wght@200;400;900&display=swap"
    rel="stylesheet">
  <style>
    :root {
      --bg: #0A0518;
      --card: #150E2D;
      --accent: #A855F7;
      --accent-glow: rgba(168, 85, 247, 0.4);
      --text: #F3E8FF;
      --muted: #A78BFA;
      --border: rgba(168, 85, 247, 0.2);
      --font-mono: 'Space Mono', monospace;
      --font-display: 'Bebas Neue', sans-serif;
      --font-body: 'Outfit', sans-serif;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: var(--font-body);
      height: 100vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    /* ═══════════════════════════════════════════════════
       HOLOGRAPHIC BACKGROUND
    ═══════════════════════════════════════════════════ */
    .bg-fx {
      position: fixed;
      inset: 0;
      z-index: -1;
      background: radial-gradient(circle at 50% 50%, #1A0B3B 0%, #0A0518 100%);
    }

    .bg-grid {
      position: fixed;
      inset: 0;
      z-index: -1;
      background-image:
        linear-gradient(var(--border) 1px, transparent 1px),
        linear-gradient(90deg, var(--border) 1px, transparent 1px);
      background-size: 80px 80px;
      opacity: 0.3;
      transform: perspective(500px) rotateX(20deg) scale(2);
      transform-origin: top;
      animation: grid-scroll 20s linear infinite;
    }

    @keyframes grid-scroll {
      from {
        background-position: 0 0;
      }

      to {
        background-position: 0 800px;
      }
    }

    /* ═══════════════════════════════════════════════════
       HEADER & HUD
    ═══════════════════════════════════════════════════ */
    .hud-header {
      height: 60px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      padding: 0 40px;
      gap: 20px;
      background: rgba(15, 10, 31, 0.8);
      backdrop-filter: blur(10px);
    }

    .hud-logo {
      font-family: var(--font-display);
      font-size: 28px;
      letter-spacing: 2px;
      color: var(--accent);
      text-shadow: 0 0 10px var(--accent-glow);
    }

    .status-group {
      display: flex;
      gap: 24px;
      margin-left: auto;
      font-family: var(--font-mono);
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .status-item span {
      color: var(--muted);
      margin-right: 6px;
    }

    /* ═══════════════════════════════════════════════════
       DASHBOARD LAYOUT
    ═══════════════════════════════════════════════════ */
    .main-deck {
      flex: 1;
      display: grid;
      grid-template-columns: 320px 1fr 320px;
      gap: 24px;
      padding: 24px;
      max-width: 1600px;
      margin: 0 auto;
      width: 100%;
    }

    .panel {
      background: rgba(21, 14, 45, 0.6);
      border: 1px solid var(--border);
      border-radius: 12px;
      backdrop-filter: blur(20px);
      display: flex;
      flex-direction: column;
      padding: 24px;
      position: relative;
      overflow: hidden;
    }

    .panel-label {
      font-family: var(--font-mono);
      font-size: 10px;
      color: var(--accent);
      margin-bottom: 20px;
      letter-spacing: 2px;
      text-transform: uppercase;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .panel-label::after {
      content: '';
      height: 1px;
      flex: 1;
      background: var(--border);
    }

    /* ═══════════════════════════════════════════════════
       ARENA (CENTER)
    ═══════════════════════════════════════════════════ */
    .arena-panel {
      padding: 0;
      overflow: hidden;
      border-color: var(--accent);
      box-shadow: inset 0 0 50px rgba(168, 85, 247, 0.1);
    }

    #arena {
      width: 100%;
      height: 100%;
      position: relative;
      background: rgba(0, 0, 0, 0.2);
    }

    .scanline {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 2px;
      background: rgba(168, 85, 247, 0.15);
      z-index: 10;
      animation: scan 4s linear infinite;
    }

    @keyframes scan {
      from {
        top: -2%;
      }

      to {
        top: 102%;
      }
    }

    /* Targets */
    .tgt {
      position: absolute;
      border-radius: 50%;
      background: transparent;
      border: 1px solid var(--muted);
      cursor: pointer;
      opacity: 0.2;
      transition: all 0.2s;
      display: flex;
      outline: none;
      align-items: center;
      justify-content: center;
      font-family: var(--font-mono);
      font-weight: 700;
      pointer-events: none;
    }

    .tgt.active-t {
      opacity: 1;
      border-color: #fff;
      background: var(--accent);
      box-shadow: 0 0 30px var(--accent-glow), 0 0 10px #fff;
      pointer-events: all;
      transform: scale(1.1);
    }

    /* Anchor button */
    .anchor-btn {
      position: absolute;
      bottom: 40px;
      left: 50%;
      transform: translateX(-50%);
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: #000;
      border: 2px solid var(--border);
      color: #fff;
      font-family: var(--font-display);
      font-size: 18px;
      cursor: pointer;
      z-index: 100;
      transition: all 0.3s;
    }

    .anchor-btn.waiting {
      border-color: var(--accent);
      background: var(--surface2);
      box-shadow: 0 0 20px var(--accent-glow);
      animation: pulse 1s infinite alternate;
    }

    @keyframes pulse {
      from {
        opacity: 0.7;
        transform: translateX(-50%) scale(0.95);
      }

      to {
        opacity: 1;
        transform: translateX(-50%) scale(1.05);
      }
    }

    /* ═══════════════════════════════════════════════════
       TELEMETRY (LEFT)
    ═══════════════════════════════════════════════════ */
    .telemetry-row {
      margin-bottom: 32px;
    }

    .tel-val {
      font-size: 48px;
      font-weight: 900;
      line-height: 1;
      color: var(--accent);
    }

    .tel-lbl {
      font-size: 11px;
      font-family: var(--font-mono);
      color: var(--muted);
      text-transform: uppercase;
      margin-top: 4px;
    }

    .mini-chart {
      height: 60px;
      display: flex;
      align-items: flex-end;
      gap: 2px;
      margin-top: 12px;
    }

    .chart-bar {
      flex: 1;
      background: var(--muted);
      opacity: 0.3;
      transition: height 0.5s;
    }

    /* ═══════════════════════════════════════════════════
       MISSION LOG (RIGHT)
    ═══════════════════════════════════════════════════ */
    .log-list {
      flex: 1;
      font-family: var(--font-mono);
      font-size: 11px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .log-item {
      display: flex;
      gap: 10px;
      color: var(--muted2);
    }

    .log-item.active {
      color: var(--text);
    }

    .log-item.done {
      color: var(--accent);
    }

    .log-item b {
      color: var(--accent);
    }

    /* ═══════════════════════════════════════════════════
       DATA OVERLAYS
    ═══════════════════════════════════════════════════ */
    .overlay {
      position: absolute;
      inset: 0;
      z-index: 500;
      background: rgba(10, 5, 24, 0.95);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 40px;
    }

    .overlay.hidden {
      display: none;
    }

    .modal {
      width: 100%;
      max-width: 600px;
      text-align: center;
    }

    .modal h2 {
      font-family: var(--font-display);
      font-size: 64px;
      color: var(--accent);
      margin-bottom: 12px;
    }

    .modal p {
      color: var(--muted);
      margin-bottom: 32px;
      font-size: 18px;
    }

    .btn-action {
      padding: 20px 48px;
      background: var(--accent);
      color: #fff;
      border: none;
      font-family: var(--font-display);
      font-size: 24px;
      cursor: pointer;
      letter-spacing: 2px;
      transition: all 0.2s;
    }

    .btn-action:hover {
      transform: scale(1.05);
      box-shadow: 0 0 30px var(--accent-glow);
    }

    /* Splits */
    .splits-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
      margin: 32px 0;
    }

    .split-card {
      background: var(--surface);
      border: 1px solid var(--border);
      padding: 20px;
      border-radius: 8px;
    }

    .split-val {
      font-size: 24px;
      font-weight: 900;
      color: var(--accent);
    }

    .split-lbl {
      font-size: 10px;
      font-family: var(--font-mono);
      color: var(--muted);
    }

    /* Footer return */
    .back-home {
      position: fixed;
      bottom: 24px;
      right: 24px;
      color: var(--muted);
      font-family: var(--font-mono);
      font-size: 11px;
      text-decoration: none;
      text-transform: uppercase;
      letter-spacing: 2px;
    }

    @media (max-width: 1200px) {
      .main-deck {
        grid-template-columns: 1fr;
        grid-template-rows: auto 1fr auto;
        height: auto;
        overflow: visible;
      }

      body {
        overflow-y: auto;
        height: auto;
      }

      .panel {
        height: 400px;
      }
    }

    .tgt.pulse {
      animation: tgtPulse 0.5s infinite alternate ease-in-out;
    }

    @keyframes tgtPulse {
      from {
        transform: scale(1);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
      }

      to {
        transform: scale(1.05);
        box-shadow: 0 0 15px var(--accent);
      }
    }
  </style>
</head>

<body>

  <div class="bg-fx"></div>
  <div class="bg-grid"></div>

  <header class="hud-header">
    <div class="hud-logo">VIPER COMMAND</div>
    <div class="status-group">
      <div id="v2-ghost-status" class="status-item" style="display: none; border-color: #FC4C02;"><span>GHOST:</span>
        <span id="v2-ghost-delta" style="color: #FC4C02;">+0.00s</span>
      </div>
      <div class="status-item"><span>SECTOR:</span> V2-PURPLE</div>
      <div class="status-item"><span>SYS:</span> ACTIVE</div>
      <div class="status-item"><span>STATUS:</span> <b id="status-txt">ACTIVE</b></div>
    </div>
  </header>

  <main class="main-deck">
    <!-- Left: Telemetry -->
    <aside class="panel">
      <div class="panel-label">Telemetry</div>

      <div class="telemetry-row">
        <div class="tel-val" id="hit-count">0</div>
        <div class="tel-lbl">Targets Captured</div>
      </div>

      <div class="telemetry-row">
        <div class="tel-val" id="avg-time">—</div>
        <div class="tel-lbl">Avg Response (ms)</div>
        <div id="fitts-plot-v2"
          style="height: 100px; width: 100%; border-top: 1px solid var(--border); margin-top: 16px; position: relative;">
          <!-- Scatter Plot via JS -->
          <div style="position: absolute; bottom: 0; left: 0; font-size: 8px; color: var(--muted2);">ID →</div>
        </div>
      </div>

      <div class="telemetry-row" style="margin-top: auto;">
        <div class="tel-val" style="font-size: 24px;">98.2%</div>
        <div class="tel-lbl">System Precision</div>
      </div>
    </aside>

    <!-- Center: Arena -->
    <section class="panel arena-panel">
      <div class="scanline"></div>
      <div id="arena">
        <button id="anchor-btn" class="anchor-btn waiting" onclick="onAnchorClick()">START</button>
      </div>
    </section>

    <!-- Right: Mission Log -->
    <aside class="panel">
      <div class="panel-label">Mission Log</div>
      <div class="log-list" id="mission-log">
        <div class="log-item active">Initializing tactical arena...</div>
        <div class="log-item">Awaiting pilot authorization...</div>
        <div class="log-item">Standard movement benchmarks active.</div>
      </div>

      <div class="panel-label" style="margin-top: 40px;">Coach Diagnostic</div>
      <div id="coach-report-v2"
        style="font-size: 11px; color: var(--accent); font-family: var(--font-mono); line-height: 1.4;">
        Awaiting final telemetry...
      </div>

      <div class="panel-label" style="margin-top: 40px;">Hardware</div>
      <div style="font-size: 12px; color: var(--muted2); font-family: var(--font-mono);">
        [SZ: L44, M28, S16]<br>
        [CALIBRATION: PASSED]
      </div>
    </aside>
  </main>

  <!-- START OVERLAY -->
  <div id="start-overlay" class="overlay">
    <div class="modal">
      <h2>PURPLE ARENA</h2>
      <p>High-precision diagnostic workstation. Average difficulty. Cyber-Viper calibration enabled.</p>
      <button class="btn-action" onclick="closeOverlay('start-overlay')">INITIALIZE</button>
    </div>
  </div>

  <!-- RESULTS OVERLAY -->
  <div id="results-overlay" class="overlay hidden">
    <div class="modal">
      <h2>RECAP COMPLETE</h2>
      <div class="splits-grid">
        <div class="split-card">
          <div class="split-val" id="r-avg">—</div>
          <div class="split-lbl">AVG TIME</div>
        </div>
        <div class="split-card">
          <div class="split-val" id="r-acc">—</div>
          <div class="split-lbl">ACCURACY</div>
        </div>
        <div class="split-card">
          <div class="split-val" id="r-total">—</div>
          <div class="split-lbl">TARGETS</div>
        </div>
      </div>

      <div class="panel" style="margin-top: 24px; border-top: 1px solid var(--border); padding: 16px;">
        <div class="panel-header">
          <div class="panel-title">PRECISION HEATMAP</div>
        </div>
        <div id="v2-heatmap"
          style="height: 120px; background: rgba(0,0,0,0.5); position: relative; border-radius: 8px; border: 1px solid var(--border); overflow: hidden; margin-top: 8px;">
          <!-- Dots via JS -->
        </div>
      </div>

      <div style="margin-top: 24px;">
        <div id="coach-report-v2" class="coach-diagnostic"
          style="border: 1px solid var(--border-glow); padding: 12px; background: rgba(168, 85, 247, 0.05);">
          > Awaiting pilot data...
        </div>
      </div>
      <div style="display: flex; gap: 12px; margin-top: 24px;">
        <button class="btn-action"
          style="flex: 1; background: var(--accent); color: #fff; border: none; font-weight: 800; letter-spacing: 1px;"
          onclick="location.reload()">RE-CALIBRATE</button>
        <button class="btn-action"
          style="flex: 1; border: 1px solid var(--accent); background: transparent; color: var(--accent); font-weight: 800; letter-spacing: 1px;"
          onclick="exportTelemetry()">EXPORT LOG</button>
      </div>
      <a href="index.html" class="btn-action"
        style="background: transparent; color: var(--muted2); border: 1px solid var(--border); display: block; margin-top: 12px; text-decoration: none; padding: 12px; text-align: center; font-size: 10px; font-weight: 800; letter-spacing: 2px;">EXIT
        TO BASE</a>
    </div>
  </div>

  <a href="index.html" class="back-home">← Return to Base</a>

  <script>
    const BTN_CONFIG = [
      { id: 'L1', type: 'large', xPct: 0.50, yPct: 0.15, label: '01' },
      { id: 'L2', type: 'large', xPct: 0.15, yPct: 0.40, label: '02' },
      { id: 'L3', type: 'large', xPct: 0.85, yPct: 0.30, label: '03' },
      { id: 'M1', type: 'medium', xPct: 0.80, yPct: 0.70, label: '04' },
      { id: 'M2', type: 'medium', xPct: 0.25, yPct: 0.75, label: '05' },
      { id: 'M3', type: 'medium', xPct: 0.55, yPct: 0.50, label: '06' },
      { id: 'S1', type: 'small', xPct: 0.10, yPct: 0.15, label: '07' },
      { id: 'S2', type: 'small', xPct: 0.90, yPct: 0.85, label: '08' },
    ];

    const SZ = { large: 44, medium: 28, small: 16 };
    let sequence = [];
    let currentIdx = 0;
    let startTime = 0;
    let timings = { large: [], medium: [], small: [] };
    let misses = 0;
    let expState = 'idle'; // idle | wait-anchor | run
    let v2Results = [];

    let cumTimes = [];
    const urlParams = new URLSearchParams(window.location.search);
    const isGP = urlParams.get('gp') === 'true';
    const gpSeed = parseInt(urlParams.get('seed') || '0');

    function mulberry32(a) {
      return function () {
        var t = a += 0x6D2B79F5;
        t = Math.imul(t ^ t >>> 15, t | 1);
        t ^= t + Math.imul(t ^ t >>> 7, t | 61);
        return ((t ^ t >>> 14) >>> 0) / 4294967296;
      }
    }

    function seededShuffle(arr, seed) {
      const rand = mulberry32(seed);
      let a = [...arr];
      for (let i = a.length - 1; i > 0; i--) {
        const j = Math.floor(rand() * (i + 1));
        [a[i], a[j]] = [a[j], a[i]];
      }
      return a;
    }

    function closeOverlay(id) {
      document.getElementById(id).classList.add('hidden');
      if (id === 'start-overlay') initArena();
    }

    function initArena() {
      const arena = document.getElementById('arena');
      arena.querySelectorAll('.tgt').forEach(t => t.remove());

      if (isGP) {
        sequence = seededShuffle([...BTN_CONFIG], gpSeed);
        document.getElementById('status-txt').textContent = 'GP MODE';
        addLog(`Daily GP initialized. Seed: ${gpSeed}`);
      } else {
        sequence = [...BTN_CONFIG].sort(() => Math.random() - 0.5);
      }

      currentIdx = 0;
      timings = { large: [], medium: [], small: [] };
      misses = 0;
      cumTimes = [];
      expState = 'wait-anchor';

      const pbCum = JSON.parse(localStorage.getItem('fitts_pb_cum_v2') || '[]');
      if (pbCum.length) document.getElementById('v2-ghost-status').style.display = 'flex';
      else document.getElementById('v2-ghost-status').style.display = 'none';

      addLog('Arena initialized. Ready for calibration.');
      buildTargets();
    }

    function buildTargets() {
      const arena = document.getElementById('arena');
      const W = arena.offsetWidth;
      const H = arena.offsetHeight;

      sequence.forEach(cfg => {
        const btn = document.createElement('div');
        btn.className = 'tgt pulse';
        btn.id = `eb-${cfg.id}`;
        btn.textContent = cfg.label;

        const s = SZ[cfg.type];
        btn.style.width = s + 'px';
        btn.style.height = s + 'px';
        btn.style.left = (cfg.xPct * W - s / 2) + 'px';
        btn.style.top = (cfg.yPct * H - s / 2) + 'px';

        btn.onclick = (e) => {
          e.stopPropagation();
          onExpClick(cfg.id, cfg.type, btn, e);
        };
        arena.appendChild(btn);
      });
    }

    function startExperiment() {
      if (expState !== 'idle') return;
      document.getElementById('start-overlay').classList.add('hidden');
      document.getElementById('v2-ghost-status').style.display = 'flex';

      expState = 'wait-anchor';
      document.getElementById('anchor-btn').classList.add('waiting');
      addLog('Experiment starting. Calibrate on the center anchor.', 'active');
      showNext();
    }

    function onAnchorClick() {
      if (expState !== 'wait-anchor') return;
      expState = 'run';
      document.getElementById('anchor-btn').classList.remove('waiting');
      addLog(`Mission started. Capturing target ${sequence[currentIdx].label}...`);
      showNext();
    }

    function showNext() {
      if (currentIdx >= sequence.length) {
        endExperiment();
        return;
      }
      const target = sequence[currentIdx];

      // Dim all
      document.querySelectorAll('.tgt').forEach(t => {
        t.classList.remove('active-t');
      });

      const tEl = document.getElementById(`eb-${target.id}`);
      tEl.classList.add('active-t');
      startTime = performance.now();
    }

    function onExpClick(id, type, btn, e) {
      if (expState !== 'run') return;
      if (id !== sequence[currentIdx].id) return;

      const ms = Math.round(performance.now() - startTime);
      timings[type].push(ms);

      const rect = btn.getBoundingClientRect();
      const clickX = e ? (e.clientX - rect.left) / rect.width : 0.5;
      const clickY = e ? (e.clientY - rect.top) / rect.height : 0.5;
      v2Results.push({ type, time: ms, clickX, clickY });

      cumTimes.push((cumTimes.length ? cumTimes[cumTimes.length - 1] : 0) + ms);
      updateGhostPace();

      addLog(`Target ${sequence[currentIdx].label} captured in ${ms}ms.`, 'done');

      currentIdx++;
      updateStats();

      if (currentIdx < sequence.length) {
        expState = 'wait-anchor';
        document.getElementById('anchor-btn').classList.add('waiting');
      } else {
        endExperiment();
      }
    }

    function updateStats() {
      const all = Object.values(timings).flat();
      const avg = Math.round(all.reduce((a, b) => a + b, 0) / all.length);
      document.getElementById('hit-count').textContent = all.length;
      document.getElementById('avg-time').textContent = avg;

      // Update mini chart
      const chartRows = document.getElementById('chart-container');
      const latest = all[all.length - 1];
      const bar = document.createElement('div');
      bar.className = 'chart-bar';
      bar.style.height = (Math.min(latest / 10, 100)) + '%';
      bar.style.opacity = '1';
      chartRows.appendChild(bar);
      if (chartRows.children.length > 20) chartRows.removeChild(chartRows.firstChild);
    }

    function endExperiment() {
      expState = 'done';
      document.getElementById('status-txt').textContent = 'RECAP';
      document.getElementById('results-overlay').classList.remove('hidden');

      const all = Object.values(timings).flat();
      const avgVal = Math.round(all.reduce((a, b) => a + b, 0) / all.length);
      const acc = Math.round((all.length / (all.length + misses)) * 100);

      document.getElementById('r-avg').textContent = avgVal + 'ms';
      document.getElementById('r-acc').textContent = acc + '%';
      document.getElementById('r-total').textContent = all.length;

      // ── FITTS PLOT & COACH AI (v6.3) ──
      const plot = document.getElementById('fitts-plot-v2');
      plot.querySelectorAll('.dot').forEach(d => d.remove());

      const sessionData = [];
      Object.keys(timings).forEach(sizeType => {
        timings[sizeType].forEach((mt, idx) => {
          // Find target config to get distance from anchor (0.5, 0.85 approx)
          const cfg = BTN_CONFIG.find(c => c.type === sizeType); // Simplified
          const dist = Math.sqrt(Math.pow(cfg.xPct - 0.5, 2) + Math.pow(cfg.yPct - 0.9, 2)) * 500;
          const id = Math.log2((2 * dist) / SZ[sizeType]);
          sessionData.push({ id, mt });
        });
      });

      const maxID = Math.max(...sessionData.map(d => d.id), 5);
      const minID = Math.min(...sessionData.map(d => d.id), 1);
      const maxMT = Math.max(...sessionData.map(d => d.mt), 1000);

      sessionData.forEach(d => {
        const dot = document.createElement('div');
        dot.className = 'dot';
        const left = ((d.id - minID) / (maxID - minID)) * 90 + 5;
        const bottom = (d.mt / maxMT) * 90 + 5;
        dot.style.cssText = `position:absolute; bottom:${bottom}%; left:${left}%; width:4px; height:4px; background:var(--accent); border-radius:50%; box-shadow:0 0 5px var(--accent-glow); opacity: 0.8;`;
        plot.appendChild(dot);
      });

      // DRAW HEATMAP (v6.7)
      const hm = document.getElementById('v2-heatmap');
      hm.querySelectorAll('.dot').forEach(d => d.remove());
      v2Results.forEach(r => {
        const dot = document.createElement('div');
        dot.className = 'dot';
        dot.style.cssText = `position:absolute; left:${r.clickX * 100}%; top:${r.clickY * 100}%; width:5px; height:5px; background:var(--accent); border-radius:50%; box-shadow:0 0 10px var(--accent); opacity:0.6; transform:translate(-50%,-50%);`;
        hm.appendChild(dot);
      });

      // Coach Diagnostic
      const highID = sessionData.filter(d => d.id > 3.5);
      const avgHigh = highID.length ? highID.reduce((a, b) => a + b.mt, 0) / highID.length : 0;
      let diagnostic = "";
      if (avgHigh > avgVal * 1.4) {
        diagnostic = "DIAGNOSTIC: Precision decay at high-ID. System suggests focusing on [S] class targets to rewire neuromuscular pathways.";
      } else if (acc < 95) {
        diagnostic = "DIAGNOSTIC: Excessive jitter. Accuracy variance exceeds safety tolerances. Recalibrate for 100% precision.";
      } else {
        diagnostic = "DIAGNOSTIC: Optimal motor control. Correlation coefficient stable. Promotion to ELITE Pilot recommended.";
      }
      document.getElementById('coach-report-v2').innerHTML = `> ${diagnostic}`;

      // Persistence
      const userName = localStorage.getItem('fitts_user_name') || 'Guest Athlete';
      const leaderboard = JSON.parse(localStorage.getItem('fitts_leaderboard') || '[]');

      // XP CALCULATION (v6.0)
      const baseXP = 100;
      const accXP = acc * 5;
      const speedXP = Math.max(0, Math.round((1000 - avgVal) / 2));
      const totalXP = Math.round((baseXP + accXP + speedXP) * 1.5); // V2 multiplier: 1.5

      const currentXP = parseInt(localStorage.getItem('fitts_xp') || '0');
      localStorage.setItem('fitts_xp', currentXP + totalXP);

      const newEntry = {
        name: userName,
        avg: avgVal,
        acc: acc,
        date: new Date().toISOString(),
        version: "v2",
        hw: localStorage.getItem('fitts_hardware') || 'mouse',
        xpGain: totalXP,
        fittsData: sessionData
      };

      leaderboard.push(newEntry);
      localStorage.setItem('fitts_leaderboard', JSON.stringify(leaderboard));

      // Update Cumulative PB (v6.5)
      const prevPBCum = JSON.parse(localStorage.getItem('fitts_pb_cum_v2') || '[]');
      if (!prevPBCum.length || cumTimes[cumTimes.length - 1] < prevPBCum[prevPBCum.length - 1]) {
        localStorage.setItem('fitts_pb_cum_v2', JSON.stringify(cumTimes));
      }
    }

    // Arena Miss
    document.getElementById('arena').onclick = () => {
      if (expState === 'run') {
        misses++;
        addLog('ARENA MISS REGISTERED', 'failed');
      }
    };
    function exportTelemetry() {
      const allTrials = [];
      Object.keys(timings).forEach(size => {
        timings[size].forEach((time, idx) => {
          allTrials.push({ size, time, index: idx });
        });
      });

      const data = {
        athlete: localStorage.getItem('fitts_user_name') || 'Guest',
        hardware: localStorage.getItem('fitts_hardware') || 'mouse',
        timestamp: new Date().toISOString(),
        version: 'v2',
        metrics: {
          avgMT: document.getElementById('r-avg').textContent,
          acc: document.getElementById('r-acc').textContent,
          targets: document.getElementById('r-total').textContent
        },
        trials: allTrials
      };

      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `fitts_telemetry_v2_${Date.now()}.json`;
      a.click();
      URL.revokeObjectURL(url);
    }

    function updateGhostPace() {
      const pbTimes = JSON.parse(localStorage.getItem('fitts_pb_cum_v2') || '[]');
      if (!pbTimes.length) return;

      const delta = document.getElementById('v2-ghost-delta');
      const currentCum = cumTimes[cumTimes.length - 1];
      const pbCum = pbTimes[cumTimes.length - 1];
      const diff = (currentCum - pbCum) / 1000;

      delta.textContent = (diff <= 0 ? '' : '+') + diff.toFixed(2) + 's';
      delta.style.color = diff <= 0 ? '#4CD964' : '#FF3B30';
    }
  </script>
</body>

</html>